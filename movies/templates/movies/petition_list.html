{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col mx-auto mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h2>Movie Petitions</h2>
          {% if user.is_authenticated %}
          <a href="{% url 'movies.create_petition' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create Petition
          </a>
          {% endif %}
        </div>
        <hr />

        <!-- Sorting options -->
        <div class="mb-3">
          <div class="btn-group" role="group">
            <a href="?sort=newest" class="btn {% if template_data.sort_by == 'newest' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-clock"></i> Newest
            </a>
            <a href="?sort=popular" class="btn {% if template_data.sort_by == 'popular' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-fire"></i> Most Popular
            </a>
            <a href="?sort=controversial" class="btn {% if template_data.sort_by == 'controversial' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-exclamation-triangle"></i> Controversial
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      {% for petition in template_data.petitions %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">{{ petition.title }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">
              <i class="fas fa-film"></i> {{ petition.movie_title }}
              {% if petition.movie_year %}
                ({{ petition.movie_year }})
              {% endif %}
            </h6>
            {% if petition.movie_director %}
            <p class="card-text text-muted small">
              <i class="fas fa-user"></i> Director: {{ petition.movie_director }}
            </p>
            {% endif %}
            <p class="card-text">{{ petition.description|truncatewords:20 }}</p>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="vote-buttons">
                {% if user.is_authenticated %}
                <button class="btn btn-sm btn-outline-success vote-btn"
                        data-petition-id="{{ petition.id }}"
                        data-vote-type="up"
                        {% if petition.user_vote == 'up' %}disabled{% endif %}>
                  <i class="fas fa-thumbs-up"></i> {{ petition.upvotes }}
                </button>
                <button class="btn btn-sm btn-outline-danger vote-btn"
                        data-petition-id="{{ petition.id }}"
                        data-vote-type="down"
                        {% if petition.user_vote == 'down' %}disabled{% endif %}>
                  <i class="fas fa-thumbs-down"></i> {{ petition.downvotes }}
                </button>
                {% else %}
                <span class="text-muted">
                  <i class="fas fa-thumbs-up"></i> {{ petition.upvotes }}
                  <i class="fas fa-thumbs-down"></i> {{ petition.downvotes }}
                </span>
                {% endif %}
              </div>
              <small class="text-muted">
                <i class="fas fa-user"></i> {{ petition.creator.username }}
              </small>
            </div>

            <div class="d-flex justify-content-between">
              <a href="{% url 'movies.petition_detail' petition.id %}" class="btn btn-outline-primary btn-sm">
                View Details
              </a>
              <small class="text-muted">
                {{ petition.created_at|date:"M d, Y" }}
              </small>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <div class="text-center py-5">
          <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">No petitions yet</h4>
          <p class="text-muted">Be the first to create a petition for a movie you'd like to see!</p>
          {% if user.is_authenticated %}
          <a href="{% url 'movies.create_petition' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create First Petition
          </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const voteButtons = document.querySelectorAll('.vote-btn');

    voteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const petitionId = this.dataset.petitionId;
            const voteType = this.dataset.voteType;

            // Disable all vote buttons for this petition
            const petitionButtons = document.querySelectorAll(`[data-petition-id="${petitionId}"]`);
            petitionButtons.forEach(btn => btn.disabled = true);

            // Get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            fetch(`{% url 'movies.vote_petition' 0 %}`.replace('0', petitionId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `vote_type=${voteType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update vote counts
                    const upButton = document.querySelector(`[data-petition-id="${petitionId}"][data-vote-type="up"]`);
                    const downButton = document.querySelector(`[data-petition-id="${petitionId}"][data-vote-type="down"]`);

                    if (upButton) {
                        upButton.innerHTML = `<i class="fas fa-thumbs-up"></i> ${data.upvotes}`;
                    }
                    if (downButton) {
                        downButton.innerHTML = `<i class="fas fa-thumbs-down"></i> ${data.downvotes}`;
                    }

                    // Re-enable buttons
                    petitionButtons.forEach(btn => btn.disabled = false);
                } else {
                    alert('Error voting: ' + data.error);
                    petitionButtons.forEach(btn => btn.disabled = false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while voting');
                petitionButtons.forEach(btn => btn.disabled = false);
            });
        });
    });
});
</script>
{% endblock content %}
